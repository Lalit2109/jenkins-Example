{
	"info": {
		"_postman_id": "azure-devops-service-connection-update",
		"name": "Azure DevOps - Update Service Connection",
		"description": "Collection to GET and UPDATE Azure DevOps service connection description using Azure App Registration (Application ID and Secret) for OAuth authentication. Tokens are automatically obtained and refreshed as needed.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "0. Get OAuth Token",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Get credentials from environment or collection variables",
							"const tenantId = pm.environment.get('tenantId') || pm.collectionVariables.get('tenantId');",
							"const applicationId = pm.environment.get('applicationId') || pm.collectionVariables.get('applicationId');",
							"const applicationSecret = pm.environment.get('applicationSecret') || pm.collectionVariables.get('applicationSecret');",
							"",
							"if (!tenantId || !applicationId || !applicationSecret) {",
							"    throw new Error('tenantId, applicationId, and applicationSecret are required.');",
							"}",
							"",
							"// Build token URL",
							"const tokenUrl = `https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/token`;",
							"pm.request.url = tokenUrl;",
							"",
							"// Build request body for client credentials flow",
							"const body = {",
							"    client_id: applicationId,",
							"    client_secret: applicationSecret,",
							"    scope: '499b84ac-1321-427f-aa17-267ca6975798/.default',",
							"    grant_type: 'client_credentials'",
							"};",
							"",
							"// Set request body",
							"pm.request.body.urlencoded = Object.keys(body).map(key => ({",
							"    key: key,",
							"    value: body[key]",
							"}));"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"if (pm.response.code === 200) {",
							"    const responseJson = pm.response.json();",
							"    const accessToken = responseJson.access_token;",
							"    const expiresIn = responseJson.expires_in || 3600;",
							"    ",
							"    // Save token and expiration time",
							"    pm.collectionVariables.set('accessToken', accessToken);",
							"    pm.collectionVariables.set('tokenExpiresAt', Date.now() + (expiresIn * 1000));",
							"    ",
							"    console.log('OAuth token obtained successfully');",
							"    console.log('Token expires in:', expiresIn, 'seconds');",
							"} else {",
							"    console.log('Failed to get OAuth token:', pm.response.code, pm.response.text());",
							"    throw new Error('Failed to obtain OAuth token');",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/x-www-form-urlencoded",
						"type": "text"
					}
				],
				"body": {
					"mode": "urlencoded",
					"urlencoded": [
						{
							"key": "client_id",
							"value": "{{applicationId}}",
							"type": "text"
						},
						{
							"key": "client_secret",
							"value": "{{applicationSecret}}",
							"type": "text"
						},
						{
							"key": "scope",
							"value": "499b84ac-1321-427f-aa17-267ca6975798/.default",
							"type": "text"
						},
						{
							"key": "grant_type",
							"value": "client_credentials",
							"type": "text"
						}
					]
				},
				"url": {
					"raw": "https://login.microsoftonline.com/{{tenantId}}/oauth2/v2.0/token",
					"protocol": "https",
					"host": [
						"login",
						"microsoftonline",
						"com"
					],
					"path": [
						"{{tenantId}}",
						"oauth2",
						"v2.0",
						"token"
					]
				},
				"description": "Gets OAuth access token using Azure App Registration (Application ID and Secret) via client credentials flow. Token is automatically saved for use in subsequent requests."
			},
			"response": []
		},
		{
			"name": "1. Get Service Connection",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Get or refresh OAuth token",
							"const accessToken = pm.collectionVariables.get('accessToken');",
							"const tokenExpiresAt = pm.collectionVariables.get('tokenExpiresAt');",
							"const now = Date.now();",
							"",
							"// Check if token exists and is not expired (with 5 minute buffer)",
							"if (!accessToken || !tokenExpiresAt || now >= (tokenExpiresAt - 300000)) {",
							"    console.log('Token missing or expired. Getting new token...');",
							"    ",
							"    // Get credentials",
							"    const tenantId = pm.environment.get('tenantId') || pm.collectionVariables.get('tenantId');",
							"    const applicationId = pm.environment.get('applicationId') || pm.collectionVariables.get('applicationId');",
							"    const applicationSecret = pm.environment.get('applicationSecret') || pm.collectionVariables.get('applicationSecret');",
							"    ",
							"    if (!tenantId || !applicationId || !applicationSecret) {",
							"        throw new Error('tenantId, applicationId, and applicationSecret are required.');",
							"    }",
							"    ",
							"    // Request new token",
							"    const tokenUrl = `https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/token`;",
							"    const tokenRequest = {",
							"        url: tokenUrl,",
							"        method: 'POST',",
							"        header: {",
							"            'Content-Type': 'application/x-www-form-urlencoded'",
							"        },",
							"        body: {",
							"            mode: 'urlencoded',",
							"            urlencoded: [",
							"                { key: 'client_id', value: applicationId },",
							"                { key: 'client_secret', value: applicationSecret },",
							"                { key: 'scope', value: '499b84ac-1321-427f-aa17-267ca6975798/.default' },",
							"                { key: 'grant_type', value: 'client_credentials' }",
							"            ]",
							"        }",
							"    };",
							"    ",
							"    pm.sendRequest(tokenRequest, function (err, res) {",
							"        if (err) {",
							"            throw new Error('Failed to get OAuth token: ' + err);",
							"        }",
							"        if (res.code === 200) {",
							"            const tokenData = res.json();",
							"            pm.collectionVariables.set('accessToken', tokenData.access_token);",
							"            pm.collectionVariables.set('tokenExpiresAt', now + (tokenData.expires_in * 1000));",
							"            console.log('New OAuth token obtained');",
							"        } else {",
							"            throw new Error('Failed to get OAuth token: ' + res.code + ' - ' + res.text());",
							"        }",
							"    });",
							"    ",
							"    // Wait a moment for async request to complete",
							"    // Note: In Postman, this is synchronous in pre-request",
							"}",
							"",
							"// Set Bearer token in header",
							"const currentToken = pm.collectionVariables.get('accessToken');",
							"pm.request.headers.remove('Authorization');",
							"pm.request.headers.add({",
							"    key: 'Authorization',",
							"    value: 'Bearer ' + currentToken",
							"});",
							"",
							"// Build URL",
							"const org = pm.environment.get('organization') || pm.collectionVariables.get('organization');",
							"const project = pm.environment.get('project') || pm.collectionVariables.get('project');",
							"const endpointId = pm.environment.get('endpointId') || pm.collectionVariables.get('endpointId');",
							"",
							"if (!org || !endpointId) {",
							"    throw new Error('Organization and EndpointId are required.');",
							"}",
							"",
							"// Build URL with optional project parameter",
							"let url = `https://dev.azure.com/${org}`;",
							"if (project) {",
							"    url += `/${project}`;",
							"}",
							"url += `/_apis/serviceendpoint/endpoints/${endpointId}?api-version=7.1-preview.4`;",
							"",
							"pm.request.url = url;"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Save the response to collection variable for PUT request",
							"if (pm.response.code === 200) {",
							"    const responseJson = pm.response.json();",
							"    pm.collectionVariables.set('serviceConnectionData', JSON.stringify(responseJson));",
							"    console.log('Service connection data saved for PUT request');",
							"    ",
							"    // Also save individual fields for reference",
							"    pm.collectionVariables.set('currentDescription', responseJson.description || '');",
							"} else {",
							"    console.log('GET request failed:', pm.response.code);",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{accessToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"url": {
					"raw": "https://dev.azure.com/{{organization}}/{{project}}/_apis/serviceendpoint/endpoints/{{endpointId}}?api-version=7.1-preview.4",
					"protocol": "https",
					"host": [
						"dev",
						"azure",
						"com"
					],
					"path": [
						"{{organization}}",
						"{{project}}",
						"_apis",
						"serviceendpoint",
						"endpoints",
						"{{endpointId}}"
					],
					"query": [
						{
							"key": "api-version",
							"value": "7.1-preview.4"
						}
					]
				},
				"description": "Retrieves the current service connection configuration. The response is automatically saved for use in the PUT request."
			},
			"response": []
		},
		{
			"name": "2. Update Service Connection Description",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Get or refresh OAuth token",
							"const accessToken = pm.collectionVariables.get('accessToken');",
							"const tokenExpiresAt = pm.collectionVariables.get('tokenExpiresAt');",
							"const now = Date.now();",
							"",
							"// Check if token exists and is not expired (with 5 minute buffer)",
							"if (!accessToken || !tokenExpiresAt || now >= (tokenExpiresAt - 300000)) {",
							"    console.log('Token missing or expired. Getting new token...');",
							"    ",
							"    // Get credentials",
							"    const tenantId = pm.environment.get('tenantId') || pm.collectionVariables.get('tenantId');",
							"    const applicationId = pm.environment.get('applicationId') || pm.collectionVariables.get('applicationId');",
							"    const applicationSecret = pm.environment.get('applicationSecret') || pm.collectionVariables.get('applicationSecret');",
							"    ",
							"    if (!tenantId || !applicationId || !applicationSecret) {",
							"        throw new Error('tenantId, applicationId, and applicationSecret are required.');",
							"    }",
							"    ",
							"    // Request new token",
							"    const tokenUrl = `https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/token`;",
							"    const tokenRequest = {",
							"        url: tokenUrl,",
							"        method: 'POST',",
							"        header: {",
							"            'Content-Type': 'application/x-www-form-urlencoded'",
							"        },",
							"        body: {",
							"            mode: 'urlencoded',",
							"            urlencoded: [",
							"                { key: 'client_id', value: applicationId },",
							"                { key: 'client_secret', value: applicationSecret },",
							"                { key: 'scope', value: '499b84ac-1321-427f-aa17-267ca6975798/.default' },",
							"                { key: 'grant_type', value: 'client_credentials' }",
							"            ]",
							"        }",
							"    };",
							"    ",
							"    pm.sendRequest(tokenRequest, function (err, res) {",
							"        if (err) {",
							"            throw new Error('Failed to get OAuth token: ' + err);",
							"        }",
							"        if (res.code === 200) {",
							"            const tokenData = res.json();",
							"            pm.collectionVariables.set('accessToken', tokenData.access_token);",
							"            pm.collectionVariables.set('tokenExpiresAt', now + (tokenData.expires_in * 1000));",
							"            console.log('New OAuth token obtained');",
							"        } else {",
							"            throw new Error('Failed to get OAuth token: ' + res.code + ' - ' + res.text());",
							"        }",
							"    });",
							"}",
							"",
							"// Set Bearer token in header",
							"const currentToken = pm.collectionVariables.get('accessToken');",
							"pm.request.headers.remove('Authorization');",
							"pm.request.headers.add({",
							"    key: 'Authorization',",
							"    value: 'Bearer ' + currentToken",
							"});",
							"",
							"// Get saved service connection data from GET request",
							"const savedData = pm.collectionVariables.get('serviceConnectionData');",
							"if (!savedData) {",
							"    throw new Error('No service connection data found. Please run the GET request first.');",
							"}",
							"",
							"// Parse the saved data",
							"let serviceConnection = JSON.parse(savedData);",
							"",
							"// Remove read-only fields that shouldn't be sent in PUT",
							"delete serviceConnection.createdBy;",
							"delete serviceConnection.administratorsGroup;",
							"delete serviceConnection.readersGroup;",
							"delete serviceConnection.groupScopeId;",
							"delete serviceConnection.operationStatus;",
							"",
							"// Handle authorization parameters - remove null passwords/secrets",
							"if (serviceConnection.authorization && serviceConnection.authorization.parameters) {",
							"    const authParams = serviceConnection.authorization.parameters;",
							"    // Remove null values (these are masked secrets from GET)",
							"    Object.keys(authParams).forEach(key => {",
							"        if (authParams[key] === null || authParams[key] === undefined) {",
							"            delete authParams[key];",
							"        }",
							"    });",
							"}",
							"",
							"// Get new description from environment/collection variable or use default",
							"const newDescription = pm.environment.get('newDescription') || pm.collectionVariables.get('newDescription') || 'Updated description';",
							"",
							"// Update description",
							"serviceConnection.description = newDescription;",
							"",
							"// Set the request body",
							"pm.request.body.raw = JSON.stringify(serviceConnection, null, 2);",
							"pm.request.body.options = {",
							"    raw: {",
							"        language: 'json'",
							"    }",
							"};",
							"",
							"// Build URL (PUT endpoint does not include project parameter per official docs)",
							"const org = pm.environment.get('organization') || pm.collectionVariables.get('organization');",
							"const endpointId = pm.environment.get('endpointId') || pm.collectionVariables.get('endpointId');",
							"",
							"if (!org || !endpointId) {",
							"    throw new Error('Organization and EndpointId are required.');",
							"}",
							"",
							"// Build URL without project parameter (as per official documentation)",
							"const url = `https://dev.azure.com/${org}/_apis/serviceendpoint/endpoints/${endpointId}?api-version=7.1-preview.4`;",
							"",
							"pm.request.url = url;",
							"",
							"console.log('Updating description to:', newDescription);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"if (pm.response.code === 200) {",
							"    console.log('Service connection description updated successfully!');",
							"    const responseJson = pm.response.json();",
							"    pm.collectionVariables.set('updatedDescription', responseJson.description || '');",
							"} else {",
							"    console.log('Update failed:', pm.response.code, pm.response.text());",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{accessToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"id\": \"{{endpointId}}\",\n    \"name\": \"ServiceConnection\",\n    \"type\": \"generic\",\n    \"url\": \"https://example.com\",\n    \"authorization\": {},\n    \"data\": {},\n    \"description\": \"{{newDescription}}\"\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "https://dev.azure.com/{{organization}}/_apis/serviceendpoint/endpoints/{{endpointId}}?api-version=7.1-preview.4",
					"protocol": "https",
					"host": [
						"dev",
						"azure",
						"com"
					],
					"path": [
						"{{organization}}",
						"_apis",
						"serviceendpoint",
						"endpoints",
						"{{endpointId}}"
					],
					"query": [
						{
							"key": "api-version",
							"value": "7.1-preview.4"
						}
					]
				},
				"description": "Updates ONLY the service connection description. Automatically uses the full response from the GET request, removes read-only fields, and only modifies the description field. Set 'newDescription' variable to specify the new description."
			},
			"response": []
		},
		{
			"name": "3. Refresh Service Connection Credentials",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Get or refresh OAuth token",
							"const accessToken = pm.collectionVariables.get('accessToken');",
							"const tokenExpiresAt = pm.collectionVariables.get('tokenExpiresAt');",
							"const now = Date.now();",
							"",
							"// Check if token exists and is not expired (with 5 minute buffer)",
							"if (!accessToken || !tokenExpiresAt || now >= (tokenExpiresAt - 300000)) {",
							"    console.log('Token missing or expired. Getting new token...');",
							"    ",
							"    // Get credentials",
							"    const tenantId = pm.environment.get('tenantId') || pm.collectionVariables.get('tenantId');",
							"    const applicationId = pm.environment.get('applicationId') || pm.collectionVariables.get('applicationId');",
							"    const applicationSecret = pm.environment.get('applicationSecret') || pm.collectionVariables.get('applicationSecret');",
							"    ",
							"    if (!tenantId || !applicationId || !applicationSecret) {",
							"        throw new Error('tenantId, applicationId, and applicationSecret are required.');",
							"    }",
							"    ",
							"    // Request new token",
							"    const tokenUrl = `https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/token`;",
							"    const tokenRequest = {",
							"        url: tokenUrl,",
							"        method: 'POST',",
							"        header: {",
							"            'Content-Type': 'application/x-www-form-urlencoded'",
							"        },",
							"        body: {",
							"            mode: 'urlencoded',",
							"            urlencoded: [",
							"                { key: 'client_id', value: applicationId },",
							"                { key: 'client_secret', value: applicationSecret },",
							"                { key: 'scope', value: '499b84ac-1321-427f-aa17-267ca6975798/.default' },",
							"                { key: 'grant_type', value: 'client_credentials' }",
							"            ]",
							"        }",
							"    };",
							"    ",
							"    pm.sendRequest(tokenRequest, function (err, res) {",
							"        if (err) {",
							"            throw new Error('Failed to get OAuth token: ' + err);",
							"        }",
							"        if (res.code === 200) {",
							"            const tokenData = res.json();",
							"            pm.collectionVariables.set('accessToken', tokenData.access_token);",
							"            pm.collectionVariables.set('tokenExpiresAt', now + (tokenData.expires_in * 1000));",
							"            console.log('New OAuth token obtained');",
							"        } else {",
							"            throw new Error('Failed to get OAuth token: ' + res.code + ' - ' + res.text());",
							"        }",
							"    });",
							"}",
							"",
							"// Set Bearer token in header",
							"const currentToken = pm.collectionVariables.get('accessToken');",
							"pm.request.headers.remove('Authorization');",
							"pm.request.headers.add({",
							"    key: 'Authorization',",
							"    value: 'Bearer ' + currentToken",
							"});",
							"",
							"// Get endpoint ID",
							"const endpointId = pm.environment.get('endpointId') || pm.collectionVariables.get('endpointId');",
							"const org = pm.environment.get('organization') || pm.collectionVariables.get('organization');",
							"const project = pm.environment.get('project') || pm.collectionVariables.get('project');",
							"",
							"if (!org || !endpointId) {",
							"    throw new Error('Organization and EndpointId are required.');",
							"}",
							"",
							"// Build URL for refresh endpoint (requires project parameter)",
							"let url = `https://dev.azure.com/${org}`;",
							"if (project) {",
							"    url += `/${project}`;",
							"}",
							"url += `/_apis/serviceendpoint/endpoints?endpointIds=${endpointId}&api-version=7.1`;",
							"",
							"pm.request.url = url;",
							"",
							"// Build request body for refresh",
							"const refreshBody = [{",
							"    endpointId: endpointId,",
							"    tokenValidityInMinutes: 60",
							"}];",
							"",
							"pm.request.body.raw = JSON.stringify(refreshBody, null, 2);",
							"pm.request.body.options = {",
							"    raw: {",
							"        language: 'json'",
							"    }",
							"};",
							"",
							"console.log('Refreshing credentials for endpoint:', endpointId);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"if (pm.response.code === 200) {",
							"    console.log('Service connection credentials refreshed successfully!');",
							"    const responseJson = pm.response.json();",
							"    if (responseJson && responseJson.length > 0) {",
							"        console.log('Refreshed endpoint:', responseJson[0].name);",
							"    }",
							"} else {",
							"    console.log('Refresh failed:', pm.response.code, pm.response.text());",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{accessToken}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "[\n    {\n        \"endpointId\": \"{{endpointId}}\",\n        \"tokenValidityInMinutes\": 60\n    }\n]",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "https://dev.azure.com/{{organization}}/{{project}}/_apis/serviceendpoint/endpoints?endpointIds={{endpointId}}&api-version=7.1",
					"protocol": "https",
					"host": [
						"dev",
						"azure",
						"com"
					],
					"path": [
						"{{organization}}",
						"{{project}}",
						"_apis",
						"serviceendpoint",
						"endpoints"
					],
					"query": [
						{
							"key": "endpointIds",
							"value": "{{endpointId}}"
						},
						{
							"key": "api-version",
							"value": "7.1"
						}
					]
				},
				"description": "Refreshes the service connection credentials (automatic SPN). This triggers Azure DevOps to generate new credentials automatically, similar to updating the description in the UI. Uses the refresh authentication endpoint."
			},
			"response": []
		},
		{
			"name": "1a. Get Service Connection (PAT)",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Generate Base64 encoded PAT for authentication",
							"const pat = pm.environment.get('pat') || pm.collectionVariables.get('pat');",
							"if (!pat) {",
							"    throw new Error('PAT (Personal Access Token) is required. Set it in environment or collection variables.');",
							"}",
							"",
							"// Base64 encode PAT (format: base64(:PAT))",
							"const authString = ':' + pat;",
							"const base64Auth = btoa(authString);",
							"pm.environment.set('base64Auth', base64Auth);",
							"",
							"// Build URL",
							"const org = pm.environment.get('organization') || pm.collectionVariables.get('organization');",
							"const project = pm.environment.get('project') || pm.collectionVariables.get('project');",
							"const endpointId = pm.environment.get('endpointId') || pm.collectionVariables.get('endpointId');",
							"",
							"if (!org || !endpointId) {",
							"    throw new Error('Organization and EndpointId are required.');",
							"}",
							"",
							"// Build URL with optional project parameter",
							"let url = `https://dev.azure.com/${org}`;",
							"if (project) {",
							"    url += `/${project}`;",
							"}",
							"url += `/_apis/serviceendpoint/endpoints/${endpointId}?api-version=7.1-preview.4`;",
							"",
							"pm.request.url = url;"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Save the response to collection variable for PUT request",
							"if (pm.response.code === 200) {",
							"    const responseJson = pm.response.json();",
							"    pm.collectionVariables.set('serviceConnectionData', JSON.stringify(responseJson));",
							"    console.log('Service connection data saved for PUT request');",
							"    ",
							"    // Also save individual fields for reference",
							"    pm.collectionVariables.set('currentDescription', responseJson.description || '');",
							"} else {",
							"    console.log('GET request failed:', pm.response.code);",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Basic {{base64Auth}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"url": {
					"raw": "https://dev.azure.com/{{organization}}/{{project}}/_apis/serviceendpoint/endpoints/{{endpointId}}?api-version=7.1-preview.4",
					"protocol": "https",
					"host": [
						"dev",
						"azure",
						"com"
					],
					"path": [
						"{{organization}}",
						"{{project}}",
						"_apis",
						"serviceendpoint",
						"endpoints",
						"{{endpointId}}"
					],
					"query": [
						{
							"key": "api-version",
							"value": "7.1-preview.4"
						}
					]
				},
				"description": "Alternative: GET request using PAT (Personal Access Token) authentication. Use this if OAuth token authentication fails."
			},
			"response": []
		},
		{
			"name": "2a. Update Service Connection Description (PAT)",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Generate Base64 encoded PAT for authentication",
							"const pat = pm.environment.get('pat') || pm.collectionVariables.get('pat');",
							"if (!pat) {",
							"    throw new Error('PAT (Personal Access Token) is required.');",
							"}",
							"",
							"const authString = ':' + pat;",
							"const base64Auth = btoa(authString);",
							"pm.environment.set('base64Auth', base64Auth);",
							"",
							"// Get saved service connection data from GET request",
							"const savedData = pm.collectionVariables.get('serviceConnectionData');",
							"if (!savedData) {",
							"    throw new Error('No service connection data found. Please run the GET request first.');",
							"}",
							"",
							"// Parse the saved data",
							"let serviceConnection = JSON.parse(savedData);",
							"",
							"// Remove read-only fields that shouldn't be sent in PUT",
							"delete serviceConnection.createdBy;",
							"delete serviceConnection.administratorsGroup;",
							"delete serviceConnection.readersGroup;",
							"delete serviceConnection.groupScopeId;",
							"delete serviceConnection.operationStatus;",
							"",
							"// Handle authorization parameters - remove null passwords/secrets",
							"if (serviceConnection.authorization && serviceConnection.authorization.parameters) {",
							"    const authParams = serviceConnection.authorization.parameters;",
							"    // Remove null values (these are masked secrets from GET)",
							"    Object.keys(authParams).forEach(key => {",
							"        if (authParams[key] === null || authParams[key] === undefined) {",
							"            delete authParams[key];",
							"        }",
							"    });",
							"}",
							"",
							"// Get new description from environment/collection variable or use default",
							"const newDescription = pm.environment.get('newDescription') || pm.collectionVariables.get('newDescription') || 'Updated description';",
							"",
							"// Update description",
							"serviceConnection.description = newDescription;",
							"",
							"// Set the request body",
							"pm.request.body.raw = JSON.stringify(serviceConnection, null, 2);",
							"pm.request.body.options = {",
							"    raw: {",
							"        language: 'json'",
							"    }",
							"};",
							"",
							"// Build URL (PUT endpoint does not include project parameter per official docs)",
							"const org = pm.environment.get('organization') || pm.collectionVariables.get('organization');",
							"const endpointId = pm.environment.get('endpointId') || pm.collectionVariables.get('endpointId');",
							"",
							"if (!org || !endpointId) {",
							"    throw new Error('Organization and EndpointId are required.');",
							"}",
							"",
							"// Build URL without project parameter (as per official documentation)",
							"const url = `https://dev.azure.com/${org}/_apis/serviceendpoint/endpoints/${endpointId}?api-version=7.1-preview.4`;",
							"",
							"pm.request.url = url;",
							"",
							"console.log('Updating description to:', newDescription);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"if (pm.response.code === 200) {",
							"    console.log('Service connection description updated successfully!');",
							"    const responseJson = pm.response.json();",
							"    pm.collectionVariables.set('updatedDescription', responseJson.description || '');",
							"} else {",
							"    console.log('Update failed:', pm.response.code, pm.response.text());",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Authorization",
						"value": "Basic {{base64Auth}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"id\": \"{{endpointId}}\",\n    \"name\": \"ServiceConnection\",\n    \"type\": \"generic\",\n    \"url\": \"https://example.com\",\n    \"authorization\": {},\n    \"data\": {},\n    \"description\": \"{{newDescription}}\"\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "https://dev.azure.com/{{organization}}/_apis/serviceendpoint/endpoints/{{endpointId}}?api-version=7.1-preview.4",
					"protocol": "https",
					"host": [
						"dev",
						"azure",
						"com"
					],
					"path": [
						"{{organization}}",
						"_apis",
						"serviceendpoint",
						"endpoints",
						"{{endpointId}}"
					],
					"query": [
						{
							"key": "api-version",
							"value": "7.1-preview.4"
						}
					]
				},
				"description": "Alternative: PUT request using PAT (Personal Access Token) authentication. Use this if OAuth token authentication fails. Automatically uses the full response from the GET request, removes read-only fields, and only modifies the description field."
			},
			"response": []
		},
		{
			"name": "3a. Refresh Service Connection Credentials (PAT)",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Generate Base64 encoded PAT for authentication",
							"const pat = pm.environment.get('pat') || pm.collectionVariables.get('pat');",
							"if (!pat) {",
							"    throw new Error('PAT (Personal Access Token) is required.');",
							"}",
							"",
							"const authString = ':' + pat;",
							"const base64Auth = btoa(authString);",
							"pm.environment.set('base64Auth', base64Auth);",
							"",
							"// Get endpoint ID",
							"const endpointId = pm.environment.get('endpointId') || pm.collectionVariables.get('endpointId');",
							"const org = pm.environment.get('organization') || pm.collectionVariables.get('organization');",
							"const project = pm.environment.get('project') || pm.collectionVariables.get('project');",
							"",
							"if (!org || !endpointId) {",
							"    throw new Error('Organization and EndpointId are required.');",
							"}",
							"",
							"// Build URL for refresh endpoint (requires project parameter)",
							"let url = `https://dev.azure.com/${org}`;",
							"if (project) {",
							"    url += `/${project}`;",
							"}",
							"url += `/_apis/serviceendpoint/endpoints?endpointIds=${endpointId}&api-version=7.1`;",
							"",
							"pm.request.url = url;",
							"",
							"// Build request body for refresh",
							"const refreshBody = [{",
							"    endpointId: endpointId,",
							"    tokenValidityInMinutes: 60",
							"}];",
							"",
							"pm.request.body.raw = JSON.stringify(refreshBody, null, 2);",
							"pm.request.body.options = {",
							"    raw: {",
							"        language: 'json'",
							"    }",
							"};",
							"",
							"console.log('Refreshing credentials for endpoint:', endpointId);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"if (pm.response.code === 200) {",
							"    console.log('Service connection credentials refreshed successfully!');",
							"    const responseJson = pm.response.json();",
							"    if (responseJson && responseJson.length > 0) {",
							"        console.log('Refreshed endpoint:', responseJson[0].name);",
							"    }",
							"} else {",
							"    console.log('Refresh failed:', pm.response.code, pm.response.text());",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Basic {{base64Auth}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "[\n    {\n        \"endpointId\": \"{{endpointId}}\",\n        \"tokenValidityInMinutes\": 60\n    }\n]",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "https://dev.azure.com/{{organization}}/{{project}}/_apis/serviceendpoint/endpoints?endpointIds={{endpointId}}&api-version=7.1",
					"protocol": "https",
					"host": [
						"dev",
						"azure",
						"com"
					],
					"path": [
						"{{organization}}",
						"{{project}}",
						"_apis",
						"serviceendpoint",
						"endpoints"
					],
					"query": [
						{
							"key": "endpointIds",
							"value": "{{endpointId}}"
						},
						{
							"key": "api-version",
							"value": "7.1"
						}
					]
				},
				"description": "Alternative: Refresh service connection credentials using PAT authentication. This triggers Azure DevOps to generate new credentials automatically for automatic SPN service connections."
			},
			"response": []
		}
	],
	"variable": [
		{
			"key": "organization",
			"value": "your-organization",
			"type": "string"
		},
		{
			"key": "project",
			"value": "your-project",
			"type": "string"
		},
		{
			"key": "endpointId",
			"value": "your-endpoint-id-guid",
			"type": "string"
		},
		{
			"key": "tenantId",
			"value": "your-tenant-id",
			"type": "string"
		},
		{
			"key": "applicationId",
			"value": "your-application-id",
			"type": "string"
		},
		{
			"key": "applicationSecret",
			"value": "your-application-secret",
			"type": "string"
		},
		{
			"key": "newDescription",
			"value": "Updated description",
			"type": "string"
		},
		{
			"key": "pat",
			"value": "your-personal-access-token",
			"type": "string"
		}
	]
}

